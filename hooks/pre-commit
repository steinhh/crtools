#!/bin/bash
#
# Pre-commit hook to automatically increment patch version number in setup.py
# and append branch name to version
#

SETUP_FILE="setup.py"

# Check if setup.py exists
if [ ! -f "$SETUP_FILE" ]; then
    echo "Error: setup.py not found"
    exit 1
fi

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Extract current version from setup.py (strip any existing branch suffix)
CURRENT_VERSION=$(grep -E '^\s*version=' "$SETUP_FILE" | sed -E 's/.*version="([0-9]+\.[0-9]+\.[0-9]+).*".*/\1/')

if [ -z "$CURRENT_VERSION" ]; then
    echo "Error: Could not find version in setup.py"
    exit 1
fi

# Split version into major.minor.patch
MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)

# Increment patch version
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}-${BRANCH}"

# Update version in setup.py
sed -i.bak -E "s/(version=\")[0-9]+\.[0-9]+\.[0-9]+(\+[^\"]+)?\"/\1$NEW_VERSION\"/" "$SETUP_FILE"
rm -f "${SETUP_FILE}.bak"

# Add the modified setup.py to the commit
git add "$SETUP_FILE"

echo "Version bumped: $CURRENT_VERSION -> $NEW_VERSION"

exit 0
